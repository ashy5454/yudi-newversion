rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    // AI Models collection
    match /aiModels/{modelId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Personas collection - Secure with ownership checks
    match /personas/{personaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.creatorId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.creatorId == request.auth.uid || isAdmin());
    }
    
    // Rooms collection - Secure with ownership checks
    match /rooms/{roomId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      
      // âœ… CRITICAL: Allow access to messages subcollection within each room
      match /messages/{messageId} {
        allow read: if isAuthenticated() && (get(/databases/$(database)/documents/rooms/$(roomId)).data.userId == request.auth.uid || isAdmin());
        allow create: if isAuthenticated() && (get(/databases/$(database)/documents/rooms/$(roomId)).data.userId == request.auth.uid || isAdmin());
        allow update: if isAuthenticated() && isAdmin();
        allow delete: if isAuthenticated() && isAdmin();
      }
    }
    
    // Messages collection - Secure with room ownership
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
        (exists(/databases/$(database)/documents/rooms/$(resource.data.roomId)) &&
         get(/databases/$(database)/documents/rooms/$(resource.data.roomId)).data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() &&
        (exists(/databases/$(database)/documents/rooms/$(request.resource.data.roomId)) &&
         get(/databases/$(database)/documents/rooms/$(request.resource.data.roomId)).data.userId == request.auth.uid);
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Moods collection - Secure with ownership checks
    match /moods/{moodId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Memories collection - Secure with ownership checks
    match /memories/{memoryId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Response Data collection (admin only)
    match /responseData/{responseId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Admins collection
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Analytics collection (admin only)
    match /analytics/{analyticId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Credits collection (nested under users)
    match /users/{userId}/credits/{creditId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow write: if isAdmin();
    }
  }
}
